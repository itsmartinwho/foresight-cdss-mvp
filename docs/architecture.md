# System Architecture

> **Note:** This document is the primary source of truth for the Foresight CDSS architecture.

## Overview

The Foresight CDSS is a modular, AI-powered clinical decision support system. It is designed with a clear separation of concerns to support both current functionality and future aspirations.

The application features several AI-powered clinical tools:
*   **Tool A (Advisor):** An AI-powered chatbot for general medical information using OpenAI's API.
*   **Tool B (Clinical Engine):** A functional AI diagnostic pipeline that processes patient data and consultation transcripts to produce diagnoses, treatment plans, SOAP notes, and document drafts.
*   **Tool C (Medical Co-pilot/Alerts System):** A real-time AI assistant that provides intelligent alerts during consultations and comprehensive post-consultation analysis. This system includes complex condition detection, drug interaction alerts, missing assessment suggestions, and comorbidity identification.

## User Roles & Application Flow

The application is designed for clinicians, with aspirational roles for administrators and support staff. The core workflows center around patient management, consultations, and interaction with the AI tools.

## Tech Stack

### Frontend
- **Core:** React, TypeScript, Next.js
- **UI:** Tailwind CSS, Shadcn/UI with glassmorphism design
- **State Management:** React Context, `useState`, `useReducer`
- **Real-time Features:** WebSocket integration for transcription and alerts

### Backend
- **Platform:** Supabase (PostgreSQL) for the database, authentication, and storage.
- **Custom Logic:** Next.js API Routes for custom endpoints (e.g., `/api/advisor`, `/api/clinical-engine`).
- **AI Tools:**
    - **Advisor:** Integrates with the OpenAI API for general medical queries.
    - **Clinical Engine:** A Python-based prototype (`src/clinical_engine_prototype/engine.py`) integrated via Next.js API routes.
    - **Alerts System:** Real-time and post-consultation AI processing using OpenAI models with sophisticated prompt templates and context management.

## Frontend Architecture

### Core Principles
- Component-based design with reusable UI components
- Centralized routing logic using Next.js App Router
- Global layout for consistent UI structure
- Modular modal system with drag-and-drop and minimization capabilities
- Real-time updates and notifications

### Directory Structure
- `src/app/`: Next.js App Router files and page components
- `src/components/`: Reusable React components organized by feature
- `src/lib/`: Utilities, services, and business logic
- `src/hooks/`: Custom React hooks for shared functionality
- `src/types/`: TypeScript interfaces and type definitions

## Backend Architecture and Data Layer

### Data Source (Supabase)
The system uses a PostgreSQL database hosted on Supabase with a FHIR-aligned schema.

#### Key Tables
- `patients`: Patient demographic information and legacy alerts
- `encounters`: Patient encounters (visits, consultations) with transcripts
- `conditions`: Diagnoses, problems, and health concerns
- `lab_results`: Laboratory and observation data
- `differential_diagnoses`: Differential diagnoses generated by the clinical engine
- `alerts`: Unified alerts system supporting both real-time and post-consultation alerts

### API Layer
- **Supabase APIs**: Auto-generated REST and GraphQL APIs for data access
- **Next.js API Routes**: Custom endpoints for AI features and complex business logic
- **Python Component**: The Clinical Engine prototype integrates via API endpoints
- **Real-time Processing**: Unified alerts service with background processing and caching

## Current Implemented Features

### Tool A: Foresight Advisor
- AI-powered medical reference chatbot using OpenAI
- Citations and follow-up question suggestions
- Voice input and audio playback capabilities
- Streaming responses for real-time interaction

### Tool B: Clinical Engine
- Comprehensive diagnostic pipeline processing patient data and transcripts
- Primary diagnosis generation with confidence scoring
- Differential diagnoses with likelihood assessment
- Automated SOAP note generation
- Treatment plan recommendations
- Document draft generation (referrals in development, prior authorization planned)

### Tool C: Medical Co-pilot/Alerts System
- **Real-time Alerts**: Minute-by-minute analysis of consultation transcripts
- **Complex Condition Detection**: AI-powered identification of autoimmune, inflammatory, oncology, and rare disease patterns
- **Drug Interaction Alerts**: Comprehensive medication interaction checking
- **Missing Assessment Alerts**: Suggestions for important questions or evaluations
- **Comorbidity Detection**: Identification of potential undiagnosed conditions
- **Post-consultation Analysis**: Comprehensive review using advanced AI models
- **Unified Alert Management**: Database-backed alert system with persistence and lifecycle management

### Core Platform Features
- **Patient Management**: Complete patient dashboard and workspace system
- **Live Voice Transcription**: Real-time conversation capture with Deepgram integration
- **Draggable Modals**: Advanced modal system with drag-and-drop, minimization, and cross-page persistence
- **Guidelines Integration**: Clinical guidelines search and reference system
- **Demo System**: Comprehensive demo mode with realistic data scenarios

## Aspirational Features (Future Development)

### Tool D: Enhanced Clinical Trial Matching
- Automated patient-trial matching based on diagnoses and eligibility criteria
- Integration with clinical trial databases
- Patient consent and enrollment workflow management

### Tool F: Advanced Prior Authorization
- Automated prior authorization document generation
- Insurance requirements integration
- Approval workflow management

### Platform Enhancements
- Multi-provider collaboration features
- Advanced analytics and reporting
- Integration with external EHR systems
- Mobile application for point-of-care use 