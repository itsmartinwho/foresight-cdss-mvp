# OpenAI Code Interpreter Integration

This document describes the integration of OpenAI's Code Interpreter API for automatic chart and table generation in both the Advisor and Clinical Engine.

## Overview

The system has been updated to use OpenAI's Assistants API with Code Interpreter tool instead of the previous Pyodide-based client-side Python execution. This provides several benefits:

- **Automatic execution**: Charts and tables are generated automatically without user interaction
- **Better performance**: Server-side execution is faster and more reliable
- **Enhanced capabilities**: Access to OpenAI's optimized Python environment
- **Reduced complexity**: Eliminates complex client-side Python execution

## Environment Variables

Add these environment variables to your `.env` file:

```bash
# OpenAI API Key (required)
OPENAI_API_KEY=your_openai_api_key_here

# Assistant IDs (optional - will create new assistants if not provided)
MEDICAL_ADVISOR_ASSISTANT_ID=asst_your_advisor_assistant_id
CLINICAL_ENGINE_ASSISTANT_ID=asst_your_clinical_engine_assistant_id
```

## How It Works

### Advisor

1. **Assistant Creation**: The system creates or uses an existing OpenAI Assistant configured with Code Interpreter tool
2. **User Query**: When a user asks a question that would benefit from visualization
3. **Automatic Analysis**: The assistant automatically determines if charts/tables would enhance the response
4. **Code Generation & Execution**: Python code is generated and executed automatically by OpenAI
5. **Result Display**: Charts are displayed directly in the chat interface

### Clinical Engine

1. **Enhanced Analysis**: The clinical engine now uses an assistant for comprehensive patient data analysis
2. **Automatic Visualizations**: Generates charts for lab trends, vital signs, medication timelines, etc.
3. **Clinical Interpretation**: Provides medical significance of all visualizations
4. **Structured Output**: Maintains compatibility with existing diagnostic workflow

## API Endpoints

### New Image Serving Endpoint

**GET** `/api/advisor/image/[fileId]`

Serves images generated by OpenAI Code Interpreter.

- **Parameters**: `fileId` - The OpenAI file ID of the generated image
- **Returns**: PNG image with appropriate caching headers
- **Usage**: Automatically called when displaying assistant-generated charts

## Event Types

The advisor now handles additional server-sent events:

- `code_interpreter_code`: Python code that was executed
- `code_interpreter_output`: Text output from code execution
- `code_interpreter_image`: Image file ID for generated charts
- `markdown_chunk`: Text content from the assistant

## Migration from Pyodide

The following components have been removed/replaced:

- **Removed**: `ChartRenderer` component (Pyodide-based)
- **Removed**: `TableRenderer` component (Pyodide-based)
- **Removed**: `code-detector.ts` (Python code detection)
- **Replaced**: Manual "Execute" buttons with automatic execution
- **Enhanced**: Image display now uses OpenAI-served images

## Clinical Engine Integration

The Clinical Engine now supports:

- **Assistant-based Analysis**: Uses OpenAI Assistant for comprehensive patient analysis
- **Automatic Visualization**: Generates relevant clinical charts automatically
- **Enhanced Output**: Includes visualization file IDs and analysis text
- **Backward Compatibility**: Maintains existing structured diagnostic workflow

## Benefits

1. **User Experience**: No more manual "Execute" buttons - charts appear automatically
2. **Reliability**: Server-side execution eliminates browser compatibility issues
3. **Performance**: Faster execution and better resource management
4. **Capabilities**: Access to latest Python libraries and OpenAI optimizations
5. **Maintenance**: Reduced complexity in frontend code

## Troubleshooting

### Assistant Creation

If no assistant IDs are provided, the system will:
1. Create new assistants automatically
2. Log the assistant IDs to console
3. Recommend adding them to environment variables for reuse

### Image Loading Issues

If charts don't display:
1. Check browser console for image loading errors
2. Verify OpenAI API key has file access permissions
3. Ensure `/api/advisor/image/[fileId]` endpoint is accessible

### Performance

For better performance:
- Set assistant IDs in environment variables to reuse existing assistants
- Monitor OpenAI usage for cost optimization
- Consider caching strategies for frequently generated visualizations

## Future Enhancements

Potential improvements:
- Real-time streaming of chart generation progress
- Support for interactive charts
- Integration with additional visualization libraries
- Enhanced clinical chart templates 