# OpenAI Code Interpreter Integration

This document describes the integration of OpenAI's Code Interpreter API for automatic chart and table generation in both the Advisor and Clinical Engine.

## Overview

The system uses OpenAI's Assistants API with Code Interpreter tool for all medical data analysis and visualization. This provides several benefits:

- **Proactive Visualizations**: Charts and tables are automatically generated when clinically relevant, even if not explicitly requested
- **High-Quality Charts**: Specific instructions ensure charts are clean, focused, and medically accurate
- **Simulated Streaming**: Text responses are streamed progressively for better UX, with chart loading placeholders
- **Server-Side Execution**: Faster and more reliable than previous client-side solutions

## Environment Variables

Add these environment variables to your `.env` file:

```bash
# OpenAI API Key (required)
OPENAI_API_KEY=your_openai_api_key_here

# Assistant IDs (optional - will create new assistants if not provided)
MEDICAL_ADVISOR_ASSISTANT_ID=asst_your_advisor_assistant_id
CLINICAL_ENGINE_ASSISTANT_ID=asst_your_clinical_engine_assistant_id
```

## How It Works

### Advisor

1. **Patient Context**: When a patient is selected, their complete clinical data (encounters, diagnoses, labs, treatments) is fetched
2. **Assistant Analysis**: The system uses a dedicated OpenAI Assistant with Code Interpreter to analyze the data
3. **Proactive Visualization**: The assistant proactively creates charts and tables for time-series data, comparisons, or clinical trends
4. **Simulated Streaming**: Text responses are streamed in 50-character chunks with 30ms delays. Chart loading placeholders are displayed
5. **Result Display**: Final charts and tables are rendered directly in the chat interface

### Clinical Engine

1. **Enhanced Analysis**: The clinical engine now uses an assistant for comprehensive patient data analysis
2. **Automatic Visualizations**: Generates charts for lab trends, vital signs, medication timelines, etc.
3. **Clinical Interpretation**: Provides medical significance of all visualizations
4. **Structured Output**: Maintains compatibility with existing diagnostic workflow

## API Endpoints

### Advisor Image Serving

**GET** `/api/advisor/image/[fileId]`

Serves images generated by OpenAI Code Interpreter.

- **Parameters**: `fileId` - The OpenAI file ID of the generated image
- **Returns**: PNG image with appropriate caching headers
- **Usage**: Automatically called when displaying assistant-generated charts

## Event Types

The advisor now handles additional server-sent events:

- `markdown_chunk`: Text content from the assistant (streamed in chunks)
- `code_interpreter_code`: Python code that was executed (used for chart loading placeholder)
- `code_interpreter_output`: Text output from code execution
- `code_interpreter_image`: Image file ID for generated charts

## Key Features

- **Automatic Visualizations**: The assistant is instructed to create relevant charts/tables even when not explicitly asked
- **High-Quality Charts**: Prompt engineering ensures charts are focused, with proper date ranges and professional styling
- **Simulated Streaming**: Provides real-time feel by chunking text responses
- **Chart Loading UI**: Displays a spinner while charts are being generated
- **Complete Data**: No artificial limits on the amount of clinical data processed

## Troubleshooting

### Assistant Creation

If no assistant IDs are provided, the system will:
1. Create new assistants automatically
2. Log the assistant IDs to console
3. Recommend adding them to environment variables for reuse

### Image Loading Issues

If charts don't display:
1. Check browser console for image loading errors
2. Verify OpenAI API key has file access permissions
3. Ensure `/api/advisor/image/[fileId]` endpoint is accessible

### Performance

For better performance:
- Set assistant IDs in environment variables to reuse existing assistants
- Monitor OpenAI usage for cost optimization
- Consider caching strategies for frequently generated visualizations

## Future Enhancements

Potential improvements:
- Real-time streaming of chart generation progress
- Support for interactive charts
- Integration with additional visualization libraries
- Enhanced clinical chart templates 